
import os
from slack_bolt import App
from slack_bolt.adapter.socket_mode import SocketModeHandler
from dotenv import load_dotenv
import re
from slack_sdk import WebClient
import logging




# Load environmental variables
load_dotenv(".env")
# initialize app
app = App(token=os.getenv("SLACK_BOT_TOKEN"))

# Regex string to detect
ticket_regex = re.compile("\d\d\d\d\d\d")

# slack web client
client = WebClient(token=os.getenv("SLACK_BOT_TOKEN"))

# Create logger
logging.basicConfig(filename='./Log.log',level=logging.DEBUG)


# React to message in slack workspace
@app.message(ticket_regex)
def send_ticket_link(message, context,logger):
    # Ticket number if match is found inside of message
    tick_num = context['matches'][0]
    # Channel ID from message
    channel_id = message["channel"]
    # JSON containing link
    attachment= [
		{
			"fallback": "Upgrade your Slack client to use messages like these.",
			"color": "#4179ef",
			"blocks": [
				{
					"type": "header",
					"text": {
						"type": "plain_text",
						"text": "Cherwell Service Management IT Ticket",
						"emoji": True
					}
				},
				{
					"type": "section",
					"text": {
						"type": "mrkdwn",
						"text": f"*Ticket*: {tick_num}\n*Hyperlink*: {os.getenv('BASE_LINK')}/{tick_num}"
					}
				},
				{
					"type": "divider"
				},
				{
					"type": "actions",
					"elements": [
						{
							"type": "button",
							"text": {
								"type": "plain_text",
								"text": "Ticket Link",
								"emoji": True
							},
							"value": "click_me_123",
							"action_id": "actionId-0",
							"url": f"{os.getenv('BASE_LINK')}/{tick_num}"
						}
					]
				}
			]
		}
	]
    # Send JSON data to channel that sent message
    try:
        client.chat_postMessage(
                channel=channel_id,
                text=f"Cherwell Ticket {tick_num}",
                attachments=attachment

        )
    except SlackApiError as e:
        logger.error(f"Error: {e}")
# start app
if __name__ == "__main__":
    SocketModeHandler(app, os.getenv("SLACK_APP_TOKEN")).start()
